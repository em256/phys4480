

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Billiards &#8212; PHYS 4480-7680 Computational Physics</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.5ea377869091fd0449014c60fc090103.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Billiards';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="LAB – Interacting Hard Spheres" href="blankLAB%20Interacting%20Hard%20Spheres.html" />
    <link rel="prev" title="Exploring Chaos with our Duffing Simulator" href="More%20Duffing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="PHYS 4480-7680 Computational Physics - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="PHYS 4480-7680 Computational Physics - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Physics 4480 / 7680 / Astronomy 7690
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Notebook%20Workflow.html">Notebook Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="Logistics.html">Logistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="Install.html">Installing Julia</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Quadratures -- Period of a Pendulum</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Period%20of%20a%20pendulum.html">Period of a Pendulum</a></li>
<li class="toctree-l1"><a class="reference internal" href="blankLAB%20Period%20of%20a%20Pendulum.html">Lab – Period of a Pendulum</a></li>




<li class="toctree-l1"><a class="reference internal" href="Integration%20Followup.html">Integration Follow-up</a></li>



</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Solving Ordinary Differential Equations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Pendulum%20dynamics.html">Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="blankLAB%20Projectile%20Motion.html">LAB – Projectile Motion</a></li>
<li class="toctree-l1"><a class="reference internal" href="Automatic%20Differentiation.html">Automatic Differentiation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced Classical Mechanics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Symplectic%20Integrators.html">Symmetry Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="blankLAB%20Chaos.html">LAB – Chaos</a></li>
<li class="toctree-l1"><a class="reference internal" href="Duffing%20Oscillator%20Followup.html">Followup on Duffing Oscillator</a></li>
<li class="toctree-l1"><a class="reference internal" href="Animating%20a%20Pendulum.html">Interactive Animation of Pendulum</a></li>
<li class="toctree-l1"><a class="reference internal" href="blankLAB%20Animating%20the%20Duffing%20Oscillator.html">Lab – Animating the Duffing Oscillator</a></li>
<li class="toctree-l1"><a class="reference internal" href="More%20Duffing.html">Exploring Chaos with our Duffing Simulator</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Dynamical Systems without differential equations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Billiards</a></li>
<li class="toctree-l1"><a class="reference internal" href="blankLAB%20Interacting%20Hard%20Spheres.html">LAB – Interacting Hard Spheres</a></li>
<li class="toctree-l1"><a class="reference internal" href="ktheory.html">Kinetic Theory of Gases</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Stochastic Methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="sampling.html">Stochastic Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="monte%20carlo%20integration.html">Stochastic approaches to integration</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Billiards.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Billiards</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#class-hierarchies-and-abstract-types">Class Hierarchies and abstract types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#billiard-class">Billiard Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ball-class">Ball Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wall-class">Wall Class</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-roundoff">Dealing with Roundoff</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#circular-walls">Circular Walls</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deciding-which-wall-to-collide-off-of">Deciding which wall to collide off of</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-velocity-after-collision">Setting Velocity after collision</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-loop">Main loop</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poincare-sections">Poincare sections</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#animation">Animation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#circular-billiard">Circular Billiard</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sinai-billiards">Sinai Billiards</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sensitive-dependence-on-initial-condidtions">Sensitive dependence on initial condidtions</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="billiards">
<h1>Billiards<a class="headerlink" href="#billiards" title="Permalink to this heading">#</a></h1>
<p>It is important in physics to work smart instead of hard.  Previously we used a differential equation solver to study chaos.  Here is a simpler setting to explore the same phenomena: Billiards.  A billiard is typically a two dimensional arena, in which a point particle elastically bounces off of the walls.  It turns out that there are arena shapes for which the behavior is chaotic, and others for which it is regular.</p>
<p>The advantage of working with Billiards is that the particle moves at constant velocity between collisions with the walls.  It introduces a new concept in simulations:  Event driven simulation.  We do away with the ODE solver – and analytically calculate the ball’s trajectory between bounces (events).  The simulation them amounts to simply enumerating the list of events.</p>
<p>To see how this works, suppose a ball is at poition <code class="docutils literal notranslate"><span class="pre">(x,y)</span></code> with velocity <code class="docutils literal notranslate"><span class="pre">(vx,vy)</span></code>.  We want to find out where it will hit a horizontal wall at <span class="math notranslate nohighlight">\(y=h\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">Plots</span><span class="p">,</span><span class="n">Logging</span><span class="p">,</span><span class="n">ProgressMeter</span><span class="p">,</span><span class="n">LinearAlgebra</span>
<span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">y</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
<span class="n">vx</span><span class="o">=-</span><span class="mf">0.8</span><span class="p">;</span><span class="n">vy</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
<span class="n">h</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
<span class="n">scatter</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;current location&quot;</span><span class="p">,</span><span class="n">xlabel</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
<span class="n">plot!</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="n">h</span><span class="p">,</span><span class="n">h</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;wall&quot;</span><span class="p">)</span>
<span class="n">plot!</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="o">+</span><span class="n">vx</span><span class="p">],[</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">vy</span><span class="p">],</span><span class="n">arrow</span><span class="o">=</span><span class="nb">true</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;velocity&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><?xml version="1.0" encoding="utf-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="600" height="400" viewBox="0 0 2400 1600">
<defs>
  <clipPath id="clip020">
    <rect x="0" y="0" width="2400" height="1600"/>
  </clipPath>
</defs>
<path clip-path="url(#clip020)" d="M0 1600 L2400 1600 L2400 8.88178e-14 L0 8.88178e-14  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"/>
<defs>
  <clipPath id="clip021">
    <rect x="480" y="0" width="1681" height="1600"/>
  </clipPath>
</defs>
<path clip-path="url(#clip020)" d="M175.445 1423.18 L2352.76 1423.18 L2352.76 47.2441 L175.445 47.2441  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"/>
<defs>
  <clipPath id="clip022">
    <rect x="175" y="47" width="2178" height="1377"/>
  </clipPath>
</defs>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="237.067,1423.18 237.067,47.2441 "/>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="750.584,1423.18 750.584,47.2441 "/>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1264.1,1423.18 1264.1,47.2441 "/>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="1777.62,1423.18 1777.62,47.2441 "/>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="2291.13,1423.18 2291.13,47.2441 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="175.445,1423.18 2352.76,1423.18 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="237.067,1423.18 237.067,1404.28 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="750.584,1423.18 750.584,1404.28 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1264.1,1423.18 1264.1,1404.28 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1777.62,1423.18 1777.62,1404.28 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="2291.13,1423.18 2291.13,1404.28 "/>
<path clip-path="url(#clip020)" d="M205.968 1468.75 L235.644 1468.75 L235.644 1472.69 L205.968 1472.69 L205.968 1468.75 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M258.583 1455.09 L246.778 1473.54 L258.583 1473.54 L258.583 1455.09 M257.356 1451.02 L263.236 1451.02 L263.236 1473.54 L268.167 1473.54 L268.167 1477.43 L263.236 1477.43 L263.236 1485.58 L258.583 1485.58 L258.583 1477.43 L242.982 1477.43 L242.982 1472.92 L257.356 1451.02 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M720.526 1468.75 L750.202 1468.75 L750.202 1472.69 L720.526 1472.69 L720.526 1468.75 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M764.322 1481.64 L780.642 1481.64 L780.642 1485.58 L758.697 1485.58 L758.697 1481.64 Q761.359 1478.89 765.943 1474.26 Q770.549 1469.61 771.73 1468.27 Q773.975 1465.74 774.855 1464.01 Q775.757 1462.25 775.757 1460.56 Q775.757 1457.8 773.813 1456.07 Q771.892 1454.33 768.79 1454.33 Q766.591 1454.33 764.137 1455.09 Q761.707 1455.86 758.929 1457.41 L758.929 1452.69 Q761.753 1451.55 764.206 1450.97 Q766.66 1450.39 768.697 1450.39 Q774.068 1450.39 777.262 1453.08 Q780.456 1455.77 780.456 1460.26 Q780.456 1462.39 779.646 1464.31 Q778.859 1466.2 776.753 1468.8 Q776.174 1469.47 773.072 1472.69 Q769.97 1475.88 764.322 1481.64 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1264.1 1454.1 Q1260.49 1454.1 1258.66 1457.66 Q1256.86 1461.2 1256.86 1468.33 Q1256.86 1475.44 1258.66 1479.01 Q1260.49 1482.55 1264.1 1482.55 Q1267.73 1482.55 1269.54 1479.01 Q1271.37 1475.44 1271.37 1468.33 Q1271.37 1461.2 1269.54 1457.66 Q1267.73 1454.1 1264.1 1454.1 M1264.1 1450.39 Q1269.91 1450.39 1272.97 1455 Q1276.04 1459.58 1276.04 1468.33 Q1276.04 1477.06 1272.97 1481.67 Q1269.91 1486.25 1264.1 1486.25 Q1258.29 1486.25 1255.21 1481.67 Q1252.16 1477.06 1252.16 1468.33 Q1252.16 1459.58 1255.21 1455 Q1258.29 1450.39 1264.1 1450.39 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1772.27 1481.64 L1788.59 1481.64 L1788.59 1485.58 L1766.65 1485.58 L1766.65 1481.64 Q1769.31 1478.89 1773.89 1474.26 Q1778.5 1469.61 1779.68 1468.27 Q1781.92 1465.74 1782.8 1464.01 Q1783.71 1462.25 1783.71 1460.56 Q1783.71 1457.8 1781.76 1456.07 Q1779.84 1454.33 1776.74 1454.33 Q1774.54 1454.33 1772.08 1455.09 Q1769.65 1455.86 1766.88 1457.41 L1766.88 1452.69 Q1769.7 1451.55 1772.15 1450.97 Q1774.61 1450.39 1776.65 1450.39 Q1782.02 1450.39 1785.21 1453.08 Q1788.4 1455.77 1788.4 1460.26 Q1788.4 1462.39 1787.59 1464.31 Q1786.81 1466.2 1784.7 1468.8 Q1784.12 1469.47 1781.02 1472.69 Q1777.92 1475.88 1772.27 1481.64 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2294.14 1455.09 L2282.34 1473.54 L2294.14 1473.54 L2294.14 1455.09 M2292.92 1451.02 L2298.8 1451.02 L2298.8 1473.54 L2303.73 1473.54 L2303.73 1477.43 L2298.8 1477.43 L2298.8 1485.58 L2294.14 1485.58 L2294.14 1477.43 L2278.54 1477.43 L2278.54 1472.92 L2292.92 1451.02 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1280.72 1532.4 L1267.82 1549.74 L1281.38 1568.04 L1274.48 1568.04 L1264.1 1554.04 L1253.72 1568.04 L1246.82 1568.04 L1260.66 1549.39 L1248 1532.4 L1254.9 1532.4 L1264.36 1545.1 L1273.81 1532.4 L1280.72 1532.4 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="175.445,1384.24 2352.76,1384.24 "/>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="175.445,1059.73 2352.76,1059.73 "/>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="175.445,735.212 2352.76,735.212 "/>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="175.445,410.699 2352.76,410.699 "/>
<polyline clip-path="url(#clip022)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:2; stroke-opacity:0.1; fill:none" points="175.445,86.1857 2352.76,86.1857 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="175.445,1423.18 175.445,47.2441 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="175.445,1384.24 194.343,1384.24 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="175.445,1059.73 194.343,1059.73 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="175.445,735.212 194.343,735.212 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="175.445,410.699 194.343,410.699 "/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="175.445,86.1857 194.343,86.1857 "/>
<path clip-path="url(#clip020)" d="M123.126 1397.58 L139.445 1397.58 L139.445 1401.52 L117.501 1401.52 L117.501 1397.58 Q120.163 1394.83 124.746 1390.2 Q129.353 1385.55 130.533 1384.2 Q132.779 1381.68 133.658 1379.94 Q134.561 1378.19 134.561 1376.5 Q134.561 1373.74 132.617 1372 Q130.695 1370.27 127.593 1370.27 Q125.394 1370.27 122.941 1371.03 Q120.51 1371.8 117.732 1373.35 L117.732 1368.62 Q120.556 1367.49 123.01 1366.91 Q125.464 1366.33 127.501 1366.33 Q132.871 1366.33 136.066 1369.02 Q139.26 1371.7 139.26 1376.19 Q139.26 1378.32 138.45 1380.25 Q137.663 1382.14 135.556 1384.74 Q134.978 1385.41 131.876 1388.62 Q128.774 1391.82 123.126 1397.58 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M132.316 1058.37 Q135.672 1059.09 137.547 1061.36 Q139.445 1063.63 139.445 1066.96 Q139.445 1072.07 135.927 1074.88 Q132.408 1077.68 125.927 1077.68 Q123.751 1077.68 121.436 1077.24 Q119.144 1076.82 116.691 1075.96 L116.691 1071.45 Q118.635 1072.58 120.95 1073.16 Q123.265 1073.74 125.788 1073.74 Q130.186 1073.74 132.478 1072.01 Q134.792 1070.27 134.792 1066.96 Q134.792 1063.9 132.64 1062.19 Q130.51 1060.45 126.691 1060.45 L122.663 1060.45 L122.663 1056.61 L126.876 1056.61 Q130.325 1056.61 132.154 1055.25 Q133.982 1053.86 133.982 1051.26 Q133.982 1048.6 132.084 1047.19 Q130.209 1045.76 126.691 1045.76 Q124.769 1045.76 122.57 1046.17 Q120.371 1046.59 117.732 1047.47 L117.732 1043.3 Q120.394 1042.56 122.709 1042.19 Q125.047 1041.82 127.107 1041.82 Q132.431 1041.82 135.533 1044.25 Q138.635 1046.66 138.635 1050.78 Q138.635 1053.65 136.992 1055.64 Q135.348 1057.61 132.316 1058.37 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M129.862 722.006 L118.056 740.455 L129.862 740.455 L129.862 722.006 M128.635 717.932 L134.515 717.932 L134.515 740.455 L139.445 740.455 L139.445 744.344 L134.515 744.344 L134.515 752.492 L129.862 752.492 L129.862 744.344 L114.26 744.344 L114.26 739.83 L128.635 717.932 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M118.543 393.419 L136.899 393.419 L136.899 397.354 L122.825 397.354 L122.825 405.826 Q123.843 405.479 124.862 405.317 Q125.88 405.132 126.899 405.132 Q132.686 405.132 136.066 408.303 Q139.445 411.474 139.445 416.891 Q139.445 422.47 135.973 425.571 Q132.501 428.65 126.181 428.65 Q124.005 428.65 121.737 428.28 Q119.492 427.909 117.084 427.169 L117.084 422.47 Q119.168 423.604 121.39 424.159 Q123.612 424.715 126.089 424.715 Q130.093 424.715 132.431 422.608 Q134.769 420.502 134.769 416.891 Q134.769 413.28 132.431 411.173 Q130.093 409.067 126.089 409.067 Q124.214 409.067 122.339 409.484 Q120.487 409.9 118.543 410.78 L118.543 393.419 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M127.917 84.3223 Q124.769 84.3223 122.918 86.475 Q121.089 88.6278 121.089 92.3778 Q121.089 96.1046 122.918 98.2805 Q124.769 100.433 127.917 100.433 Q131.066 100.433 132.894 98.2805 Q134.746 96.1046 134.746 92.3778 Q134.746 88.6278 132.894 86.475 Q131.066 84.3223 127.917 84.3223 M137.2 69.6696 L137.2 73.9288 Q135.441 73.0955 133.635 72.6557 Q131.853 72.2158 130.093 72.2158 Q125.464 72.2158 123.01 75.3408 Q120.58 78.4658 120.232 84.7852 Q121.598 82.7713 123.658 81.7065 Q125.718 80.6186 128.195 80.6186 Q133.404 80.6186 136.413 83.7899 Q139.445 86.938 139.445 92.3778 Q139.445 97.7018 136.297 100.919 Q133.149 104.137 127.917 104.137 Q121.922 104.137 118.751 99.5537 Q115.58 94.9472 115.58 86.2204 Q115.58 78.026 119.468 73.1649 Q123.357 68.2807 129.908 68.2807 Q131.667 68.2807 133.45 68.6279 Q135.255 68.9751 137.2 69.6696 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M67.3143 733.525 Q73.68 736.008 75.6216 738.363 Q77.5631 740.718 77.5631 744.665 L77.5631 749.344 L72.6615 749.344 L72.6615 745.906 Q72.6615 743.487 71.5157 742.151 Q70.3699 740.814 66.1048 739.191 L63.4312 738.14 L28.3562 752.559 L28.3562 746.352 L56.238 735.212 L28.3562 724.072 L28.3562 717.865 L67.3143 733.525 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><circle clip-path="url(#clip022)" cx="1520.86" cy="1384.24" r="14.4" fill="#009af9" fill-rule="evenodd" fill-opacity="1" stroke="#000000" stroke-opacity="1" stroke-width="3.2"/>
<polyline clip-path="url(#clip022)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="237.067,410.699 2291.13,410.699 "/>
<polyline clip-path="url(#clip022)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1520.86,1384.24 1315.45,86.1857 "/>
<polyline clip-path="url(#clip022)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1303.3,124.557 1315.45,86.1857 1338.86,118.93 "/>
<polyline clip-path="url(#clip022)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1315.45,86.1857 1520.86,1384.24 "/>
<path clip-path="url(#clip020)" d="M1694.9 300.469 L2280.18 300.469 L2280.18 93.1086 L1694.9 93.1086  Z" fill="#ffffff" fill-rule="evenodd" fill-opacity="1"/>
<polyline clip-path="url(#clip020)" style="stroke:#000000; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1694.9,300.469 2280.18,300.469 2280.18,93.1086 1694.9,93.1086 1694.9,300.469 "/>
<circle clip-path="url(#clip020)" cx="1791.67" cy="144.949" r="20.48" fill="#009af9" fill-rule="evenodd" fill-opacity="1" stroke="#000000" stroke-opacity="1" stroke-width="4.55111"/>
<path clip-path="url(#clip020)" d="M1908.95 137.298 L1908.95 141.28 Q1907.15 140.284 1905.32 139.798 Q1903.51 139.289 1901.66 139.289 Q1897.52 139.289 1895.22 141.928 Q1892.93 144.544 1892.93 149.289 Q1892.93 154.034 1895.22 156.673 Q1897.52 159.289 1901.66 159.289 Q1903.51 159.289 1905.32 158.803 Q1907.15 158.293 1908.95 157.298 L1908.95 161.233 Q1907.17 162.067 1905.25 162.483 Q1903.35 162.9 1901.2 162.9 Q1895.34 162.9 1891.89 159.219 Q1888.44 155.539 1888.44 149.289 Q1888.44 142.946 1891.91 139.312 Q1895.41 135.678 1901.47 135.678 Q1903.44 135.678 1905.32 136.095 Q1907.19 136.488 1908.95 137.298 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1915.92 151.997 L1915.92 136.303 L1920.18 136.303 L1920.18 151.835 Q1920.18 155.516 1921.61 157.368 Q1923.05 159.196 1925.92 159.196 Q1929.37 159.196 1931.36 156.997 Q1933.37 154.798 1933.37 151.002 L1933.37 136.303 L1937.63 136.303 L1937.63 162.229 L1933.37 162.229 L1933.37 158.247 Q1931.82 160.608 1929.76 161.766 Q1927.72 162.9 1925.02 162.9 Q1920.55 162.9 1918.23 160.122 Q1915.92 157.344 1915.92 151.997 M1926.64 135.678 L1926.64 135.678 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1961.43 140.284 Q1960.71 139.868 1959.85 139.682 Q1959.02 139.474 1958 139.474 Q1954.39 139.474 1952.45 141.835 Q1950.53 144.173 1950.53 148.571 L1950.53 162.229 L1946.24 162.229 L1946.24 136.303 L1950.53 136.303 L1950.53 140.331 Q1951.87 137.969 1954.02 136.835 Q1956.17 135.678 1959.25 135.678 Q1959.69 135.678 1960.22 135.747 Q1960.76 135.794 1961.4 135.909 L1961.43 140.284 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1980.09 140.284 Q1979.37 139.868 1978.51 139.682 Q1977.68 139.474 1976.66 139.474 Q1973.05 139.474 1971.1 141.835 Q1969.18 144.173 1969.18 148.571 L1969.18 162.229 L1964.9 162.229 L1964.9 136.303 L1969.18 136.303 L1969.18 140.331 Q1970.53 137.969 1972.68 136.835 Q1974.83 135.678 1977.91 135.678 Q1978.35 135.678 1978.88 135.747 Q1979.41 135.794 1980.06 135.909 L1980.09 140.284 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2005.69 148.201 L2005.69 150.284 L1986.1 150.284 Q1986.38 154.682 1988.74 156.997 Q1991.13 159.289 1995.36 159.289 Q1997.82 159.289 2000.11 158.687 Q2002.42 158.085 2004.69 156.881 L2004.69 160.909 Q2002.4 161.881 1999.99 162.391 Q1997.59 162.9 1995.11 162.9 Q1988.9 162.9 1985.27 159.289 Q1981.66 155.678 1981.66 149.52 Q1981.66 143.155 1985.09 139.428 Q1988.53 135.678 1994.37 135.678 Q1999.6 135.678 2002.63 139.057 Q2005.69 142.414 2005.69 148.201 M2001.43 146.951 Q2001.38 143.456 1999.46 141.372 Q1997.56 139.289 1994.41 139.289 Q1990.85 139.289 1988.7 141.303 Q1986.57 143.317 1986.24 146.974 L2001.43 146.951 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2034.23 146.581 L2034.23 162.229 L2029.97 162.229 L2029.97 146.719 Q2029.97 143.039 2028.53 141.21 Q2027.1 139.382 2024.23 139.382 Q2020.78 139.382 2018.79 141.581 Q2016.8 143.78 2016.8 147.576 L2016.8 162.229 L2012.52 162.229 L2012.52 136.303 L2016.8 136.303 L2016.8 140.331 Q2018.33 137.993 2020.39 136.835 Q2022.47 135.678 2025.18 135.678 Q2029.65 135.678 2031.94 138.456 Q2034.23 141.21 2034.23 146.581 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2046.94 128.942 L2046.94 136.303 L2055.71 136.303 L2055.71 139.613 L2046.94 139.613 L2046.94 153.687 Q2046.94 156.858 2047.79 157.761 Q2048.67 158.664 2051.33 158.664 L2055.71 158.664 L2055.71 162.229 L2051.33 162.229 Q2046.4 162.229 2044.53 160.4 Q2042.65 158.548 2042.65 153.687 L2042.65 139.613 L2039.53 139.613 L2039.53 136.303 L2042.65 136.303 L2042.65 128.942 L2046.94 128.942 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2076.38 126.21 L2080.64 126.21 L2080.64 162.229 L2076.38 162.229 L2076.38 126.21 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2099.6 139.289 Q2096.17 139.289 2094.18 141.974 Q2092.19 144.636 2092.19 149.289 Q2092.19 153.942 2094.16 156.627 Q2096.15 159.289 2099.6 159.289 Q2103 159.289 2104.99 156.604 Q2106.98 153.918 2106.98 149.289 Q2106.98 144.682 2104.99 141.997 Q2103 139.289 2099.6 139.289 M2099.6 135.678 Q2105.15 135.678 2108.33 139.289 Q2111.5 142.9 2111.5 149.289 Q2111.5 155.655 2108.33 159.289 Q2105.15 162.9 2099.6 162.9 Q2094.02 162.9 2090.85 159.289 Q2087.7 155.655 2087.7 149.289 Q2087.7 142.9 2090.85 139.289 Q2094.02 135.678 2099.6 135.678 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2137.21 137.298 L2137.21 141.28 Q2135.41 140.284 2133.58 139.798 Q2131.77 139.289 2129.92 139.289 Q2125.78 139.289 2123.49 141.928 Q2121.2 144.544 2121.2 149.289 Q2121.2 154.034 2123.49 156.673 Q2125.78 159.289 2129.92 159.289 Q2131.77 159.289 2133.58 158.803 Q2135.41 158.293 2137.21 157.298 L2137.21 161.233 Q2135.43 162.067 2133.51 162.483 Q2131.61 162.9 2129.46 162.9 Q2123.6 162.9 2120.15 159.219 Q2116.7 155.539 2116.7 149.289 Q2116.7 142.946 2120.18 139.312 Q2123.67 135.678 2129.74 135.678 Q2131.7 135.678 2133.58 136.095 Q2135.45 136.488 2137.21 137.298 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2156.4 149.196 Q2151.24 149.196 2149.25 150.377 Q2147.26 151.557 2147.26 154.405 Q2147.26 156.673 2148.74 158.016 Q2150.25 159.335 2152.82 159.335 Q2156.36 159.335 2158.49 156.835 Q2160.64 154.312 2160.64 150.145 L2160.64 149.196 L2156.4 149.196 M2164.9 147.437 L2164.9 162.229 L2160.64 162.229 L2160.64 158.293 Q2159.18 160.655 2157.01 161.789 Q2154.83 162.9 2151.68 162.9 Q2147.7 162.9 2145.34 160.678 Q2143 158.432 2143 154.682 Q2143 150.307 2145.92 148.085 Q2148.86 145.863 2154.67 145.863 L2160.64 145.863 L2160.64 145.446 Q2160.64 142.507 2158.7 140.909 Q2156.77 139.289 2153.28 139.289 Q2151.06 139.289 2148.95 139.821 Q2146.84 140.354 2144.9 141.419 L2144.9 137.483 Q2147.24 136.581 2149.44 136.141 Q2151.64 135.678 2153.72 135.678 Q2159.34 135.678 2162.12 138.594 Q2164.9 141.511 2164.9 147.437 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2177.89 128.942 L2177.89 136.303 L2186.66 136.303 L2186.66 139.613 L2177.89 139.613 L2177.89 153.687 Q2177.89 156.858 2178.74 157.761 Q2179.62 158.664 2182.28 158.664 L2186.66 158.664 L2186.66 162.229 L2182.28 162.229 Q2177.35 162.229 2175.48 160.4 Q2173.6 158.548 2173.6 153.687 L2173.6 139.613 L2170.48 139.613 L2170.48 136.303 L2173.6 136.303 L2173.6 128.942 L2177.89 128.942 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2192.26 136.303 L2196.52 136.303 L2196.52 162.229 L2192.26 162.229 L2192.26 136.303 M2192.26 126.21 L2196.52 126.21 L2196.52 131.604 L2192.26 131.604 L2192.26 126.21 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2215.48 139.289 Q2212.05 139.289 2210.06 141.974 Q2208.07 144.636 2208.07 149.289 Q2208.07 153.942 2210.04 156.627 Q2212.03 159.289 2215.48 159.289 Q2218.88 159.289 2220.87 156.604 Q2222.86 153.918 2222.86 149.289 Q2222.86 144.682 2220.87 141.997 Q2218.88 139.289 2215.48 139.289 M2215.48 135.678 Q2221.03 135.678 2224.2 139.289 Q2227.38 142.9 2227.38 149.289 Q2227.38 155.655 2224.2 159.289 Q2221.03 162.9 2215.48 162.9 Q2209.9 162.9 2206.73 159.289 Q2203.58 155.655 2203.58 149.289 Q2203.58 142.9 2206.73 139.289 Q2209.9 135.678 2215.48 135.678 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2255.99 146.581 L2255.99 162.229 L2251.73 162.229 L2251.73 146.719 Q2251.73 143.039 2250.29 141.21 Q2248.86 139.382 2245.99 139.382 Q2242.54 139.382 2240.55 141.581 Q2238.56 143.78 2238.56 147.576 L2238.56 162.229 L2234.27 162.229 L2234.27 136.303 L2238.56 136.303 L2238.56 140.331 Q2240.08 137.993 2242.14 136.835 Q2244.23 135.678 2246.94 135.678 Q2251.4 135.678 2253.69 138.456 Q2255.99 141.21 2255.99 146.581 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><polyline clip-path="url(#clip020)" style="stroke:#e26f46; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1719.1,196.789 1864.25,196.789 "/>
<path clip-path="url(#clip020)" d="M1888.44 188.143 L1892.7 188.143 L1898.03 208.374 L1903.33 188.143 L1908.35 188.143 L1913.67 208.374 L1918.97 188.143 L1923.23 188.143 L1916.45 214.069 L1911.43 214.069 L1905.85 192.819 L1900.25 214.069 L1895.22 214.069 L1888.44 188.143 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1941.47 201.036 Q1936.31 201.036 1934.32 202.217 Q1932.33 203.397 1932.33 206.245 Q1932.33 208.513 1933.81 209.856 Q1935.32 211.175 1937.89 211.175 Q1941.43 211.175 1943.56 208.675 Q1945.71 206.152 1945.71 201.985 L1945.71 201.036 L1941.47 201.036 M1949.97 199.277 L1949.97 214.069 L1945.71 214.069 L1945.71 210.133 Q1944.25 212.495 1942.08 213.629 Q1939.9 214.74 1936.75 214.74 Q1932.77 214.74 1930.41 212.518 Q1928.07 210.272 1928.07 206.522 Q1928.07 202.147 1930.99 199.925 Q1933.93 197.703 1939.74 197.703 L1945.71 197.703 L1945.71 197.286 Q1945.71 194.347 1943.77 192.749 Q1941.84 191.129 1938.35 191.129 Q1936.13 191.129 1934.02 191.661 Q1931.91 192.194 1929.97 193.259 L1929.97 189.323 Q1932.31 188.421 1934.51 187.981 Q1936.71 187.518 1938.79 187.518 Q1944.41 187.518 1947.19 190.434 Q1949.97 193.351 1949.97 199.277 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1958.74 178.05 L1963 178.05 L1963 214.069 L1958.74 214.069 L1958.74 178.05 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1971.91 178.05 L1976.17 178.05 L1976.17 214.069 L1971.91 214.069 L1971.91 178.05 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><polyline clip-path="url(#clip020)" style="stroke:#3da44d; stroke-linecap:round; stroke-linejoin:round; stroke-width:4; stroke-opacity:1; fill:none" points="1719.1,248.629 1864.25,248.629 "/>
<path clip-path="url(#clip020)" d="M1888.44 239.983 L1892.96 239.983 L1901.06 261.742 L1909.16 239.983 L1913.67 239.983 L1903.95 265.909 L1898.16 265.909 L1888.44 239.983 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1941.73 251.881 L1941.73 253.964 L1922.15 253.964 Q1922.42 258.362 1924.78 260.677 Q1927.17 262.969 1931.4 262.969 Q1933.86 262.969 1936.15 262.367 Q1938.47 261.765 1940.73 260.561 L1940.73 264.589 Q1938.44 265.561 1936.03 266.071 Q1933.63 266.58 1931.15 266.58 Q1924.95 266.58 1921.31 262.969 Q1917.7 259.358 1917.7 253.2 Q1917.7 246.835 1921.13 243.108 Q1924.58 239.358 1930.41 239.358 Q1935.64 239.358 1938.67 242.737 Q1941.73 246.094 1941.73 251.881 M1937.47 250.631 Q1937.42 247.136 1935.5 245.052 Q1933.6 242.969 1930.46 242.969 Q1926.89 242.969 1924.74 244.983 Q1922.61 246.997 1922.28 250.654 L1937.47 250.631 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1948.72 229.89 L1952.98 229.89 L1952.98 265.909 L1948.72 265.909 L1948.72 229.89 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M1971.94 242.969 Q1968.51 242.969 1966.52 245.654 Q1964.53 248.316 1964.53 252.969 Q1964.53 257.622 1966.5 260.307 Q1968.49 262.969 1971.94 262.969 Q1975.34 262.969 1977.33 260.284 Q1979.32 257.598 1979.32 252.969 Q1979.32 248.362 1977.33 245.677 Q1975.34 242.969 1971.94 242.969 M1971.94 239.358 Q1977.49 239.358 1980.66 242.969 Q1983.84 246.58 1983.84 252.969 Q1983.84 259.335 1980.66 262.969 Q1977.49 266.58 1971.94 266.58 Q1966.36 266.58 1963.19 262.969 Q1960.04 259.335 1960.04 252.969 Q1960.04 246.58 1963.19 242.969 Q1966.36 239.358 1971.94 239.358 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2009.55 240.978 L2009.55 244.96 Q2007.75 243.964 2005.92 243.478 Q2004.11 242.969 2002.26 242.969 Q1998.12 242.969 1995.83 245.608 Q1993.53 248.224 1993.53 252.969 Q1993.53 257.714 1995.83 260.353 Q1998.12 262.969 2002.26 262.969 Q2004.11 262.969 2005.92 262.483 Q2007.75 261.973 2009.55 260.978 L2009.55 264.913 Q2007.77 265.747 2005.85 266.163 Q2003.95 266.58 2001.8 266.58 Q1995.94 266.58 1992.49 262.899 Q1989.04 259.219 1989.04 252.969 Q1989.04 246.626 1992.52 242.992 Q1996.01 239.358 2002.08 239.358 Q2004.04 239.358 2005.92 239.775 Q2007.79 240.168 2009.55 240.978 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2016.96 239.983 L2021.22 239.983 L2021.22 265.909 L2016.96 265.909 L2016.96 239.983 M2016.96 229.89 L2021.22 229.89 L2021.22 235.284 L2016.96 235.284 L2016.96 229.89 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2034.34 232.622 L2034.34 239.983 L2043.12 239.983 L2043.12 243.293 L2034.34 243.293 L2034.34 257.367 Q2034.34 260.538 2035.2 261.441 Q2036.08 262.344 2038.74 262.344 L2043.12 262.344 L2043.12 265.909 L2038.74 265.909 Q2033.81 265.909 2031.94 264.08 Q2030.06 262.228 2030.06 257.367 L2030.06 243.293 L2026.94 243.293 L2026.94 239.983 L2030.06 239.983 L2030.06 232.622 L2034.34 232.622 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /><path clip-path="url(#clip020)" d="M2059.51 268.316 Q2057.7 272.946 2055.99 274.358 Q2054.27 275.77 2051.4 275.77 L2048 275.77 L2048 272.205 L2050.5 272.205 Q2052.26 272.205 2053.23 271.372 Q2054.21 270.538 2055.39 267.436 L2056.15 265.492 L2045.66 239.983 L2050.18 239.983 L2058.28 260.261 L2066.38 239.983 L2070.89 239.983 L2059.51 268.316 Z" fill="#000000" fill-rule="nonzero" fill-opacity="1" /></svg>
</div></div>
</div>
<p>The ball will hit the wall at time <span class="math notranslate nohighlight">\(t=(h-y)/v_y\)</span>.  at the collision point, it will be at position <span class="math notranslate nohighlight">\((x^\prime,y^\prime)=(x+ v_x t,h)\)</span>.  At the wall the <span class="math notranslate nohighlight">\(y\)</span> velocity flips, but <span class="math notranslate nohighlight">\(v_x\)</span> remains the same: <span class="math notranslate nohighlight">\((v_x^\prime,v_y^\prime)=(v_x,-v_y)\)</span>.</p>
<p>Suppose we have a rectangular billiard.  What we will do is simply calcuate the time at which the particle will hit each of the four walls.  We choose the earliest positive time, and get the collision conditions from that wall.  We set <span class="math notranslate nohighlight">\(x,y,v_x,v_y\)</span> accordingly, and repeat.  We end up with a discrete map.</p>
<p>As you see, we do not discretize time in any way.  Thus this strategy is also referred to as a “continuous time simulation”.</p>
<p>It is convenient to make some data structures, and dive into a bit more computer science.</p>
<section id="class-hierarchies-and-abstract-types">
<h2>Class Hierarchies and abstract types<a class="headerlink" href="#class-hierarchies-and-abstract-types" title="Permalink to this heading">#</a></h2>
<section id="billiard-class">
<h3>Billiard Class<a class="headerlink" href="#billiard-class" title="Permalink to this heading">#</a></h3>
<p>Lets create a class which corresponds to a billiards.  It should know about where the walls are, and where the ball is.  For plotting it is also for it to know about its “bounding box” – which is the coordinates of a rectangle which encloses the entire shape.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">Billiard</span>
<span class="w">    </span><span class="n">walls</span><span class="w"> </span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Wall</span><span class="p">}</span>
<span class="w">    </span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span>
<span class="w">    </span><span class="n">boundingbox</span><span class="w"> </span><span class="c"># x1,y1,x2,y2 = corners of a rectangle</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">UndefVarError</span>: `Wall` not defined

<span class="ne">Stacktrace</span>:
 <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="n">scope</span>
   <span class="o">@</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>Here we have stored the wall information as an <code class="docutils literal notranslate"><span class="pre">Array</span></code> of <code class="docutils literal notranslate"><span class="pre">Wall</span></code> objects – which we have not yet defined.  Similarly, the information about the ball is in a <code class="docutils literal notranslate"><span class="pre">Ball</span></code> object.  Of course, we get an error message because we have not yet devied these types.</p>
<p>This restriction of attributes to certain types is useful, as it prevents unexpected behavior.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">intcontainer</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">::</span><span class="kt">Int64</span>
<span class="k">end</span>

<span class="k">struct</span> <span class="kt">floatcontainer</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">::</span><span class="kt">Float64</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">=</span><span class="n">intcontainer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">i</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">j</span><span class="o">=</span><span class="n">floatcontainer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">j</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">intcontainer</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The other possible advantage of declaring your types inside your container objects is that it gives the compiler some extra information about how to work with them.  This can lead to faster code.  We will look more into that later in the course.  Right now the main reason for type declarations is to make the programming easier.</p>
</section>
<section id="ball-class">
<h3>Ball Class<a class="headerlink" href="#ball-class" title="Permalink to this heading">#</a></h3>
<p>Lets now make our <code class="docutils literal notranslate"><span class="pre">Ball</span></code> object.  It needs to store the position, velocity, and time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">mutable</span><span class="w"> </span><span class="k">struct</span> <span class="kt">Ball</span>
<span class="w">    </span><span class="n">x</span>
<span class="w">    </span><span class="n">y</span>
<span class="w">    </span><span class="n">vx</span>
<span class="w">    </span><span class="n">vy</span>
<span class="w">    </span><span class="n">t</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>(Again – we could define the types of these quantities.)</p>
<p>We will also define some <em>interfaces</em>.  These are ways to get interact with the ball object without having to mess with how we implemented the internal structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">set_xvt!</span><span class="p">(</span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">xy</span><span class="p">,</span><span class="n">vxy</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">ball</span><span class="o">.</span><span class="n">y</span><span class="o">=</span><span class="n">xy</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span><span class="n">ball</span><span class="o">.</span><span class="n">vy</span><span class="o">=</span><span class="n">vxy</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">t</span><span class="o">=</span><span class="n">t</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ball</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">set_r!</span><span class="p">(</span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">x</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">y</span><span class="o">=</span><span class="n">y</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ball</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">set_r!</span><span class="p">(</span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">ball</span><span class="o">.</span><span class="n">y</span><span class="o">=</span><span class="n">r</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ball</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">set_v!</span><span class="p">(</span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span><span class="n">ball</span><span class="o">.</span><span class="n">vy</span><span class="o">=</span><span class="n">v</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ball</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">set_v!</span><span class="p">(</span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">)</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">vx</span><span class="o">=</span><span class="n">vx</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">vy</span><span class="o">=</span><span class="n">vy</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ball</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">set_t!</span><span class="p">(</span><span class="n">ball</span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="n">ball</span><span class="o">.</span><span class="n">t</span><span class="o">=</span><span class="n">t</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ball</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">get_r</span><span class="p">(</span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="n">ball</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">ball</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">get_v</span><span class="p">(</span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="n">ball</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span><span class="n">ball</span><span class="o">.</span><span class="n">vy</span><span class="p">]</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">get_t</span><span class="p">(</span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ball</span><span class="o">.</span><span class="n">t</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>These interfaces are not necessary, but they can be nice.  In particular, they allow a separation between how one manipulates the data, and how it is stored.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b1</span><span class="o">=</span><span class="n">Ball</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">get_r</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">set_r!</span><span class="p">(</span><span class="n">b1</span><span class="p">,(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Lets add another thing to our <code class="docutils literal notranslate"><span class="pre">Ball</span></code> object – lets make its printout a little more transparent</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Base</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="kt">IO</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span><span class="o">=</span><span class="n">print</span><span class="p">(</span><span class="n">io</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Ball &lt;&lt; r=&quot;</span><span class="o">*</span><span class="n">repr</span><span class="p">((</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="p">))</span><span class="o">*</span>
<span class="w">    </span><span class="s">&quot; v=&quot;</span><span class="o">*</span><span class="n">repr</span><span class="p">((</span><span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="p">))</span><span class="o">*</span>
<span class="w">    </span><span class="s">&quot; t=&quot;</span><span class="o">*</span><span class="n">repr</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="s">&quot; &gt;&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">set_t!</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A final thing is I like to add some alternative constructors</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Ball</span><span class="p">(;</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">,</span><span class="n">t</span><span class="p">)</span><span class="o">=</span><span class="n">Ball</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">,</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="c"># keyword constructor</span>
<span class="k">function</span><span class="w"> </span><span class="n">Ball</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="c"># constructor using containers</span>
<span class="w">    </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">r</span>
<span class="w">    </span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="o">=</span><span class="n">v</span>
<span class="w">    </span><span class="n">Ball</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">Ball</span><span class="p">(;</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">t</span><span class="p">)</span><span class="o">=</span><span class="n">Ball</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="c"># keyword constructor using containers</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="wall-class">
<h3>Wall Class<a class="headerlink" href="#wall-class" title="Permalink to this heading">#</a></h3>
<p>Now lets make our <code class="docutils literal notranslate"><span class="pre">Wall</span></code> object.  Here we have a problem.  The description of a horizontal wall is going to be different from a vertical wall.  We may also want to create a slanted wall, or even a curved wall.  Each of these will need different storage requirements.</p>
<p>The solution is to use a heirarchy of classes.  We will make a generic <code class="docutils literal notranslate"><span class="pre">Wall</span></code> class, and then make subclasses.  The generic superclass <code class="docutils literal notranslate"><span class="pre">Wall</span></code> will never actually be instantiated.  It will be what is known as an <em>Abstract Class</em> or <em>Abstract Type</em>.  It is just a label which is used to organize other types.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">abstract</span><span class="w"> </span><span class="k">type</span> <span class="kt">Wall</span><span class="w"> </span><span class="k">end</span>

<span class="k">struct</span> <span class="kt">Hwall</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Wall</span>
<span class="w">    </span><span class="n">y</span>
<span class="k">end</span>

<span class="k">struct</span> <span class="kt">Vwall</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Wall</span>
<span class="w">    </span><span class="n">x</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>One thing we might want to do with a wall is answer the question:  Given the ball’s current postion and velocity, when will it hit the wall?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">impact_time</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Hwall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="o">+</span><span class="n">b</span><span class="o">.</span><span class="n">t</span>
<span class="n">impact_time</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Vwall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="o">+</span><span class="n">b</span><span class="o">.</span><span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<p>I am bad at remembering the order in which I need to give arguments, so lets overload another signature:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">impact_time</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">w</span><span class="o">::</span><span class="kt">Wall</span><span class="p">)</span><span class="o">=</span><span class="n">impact_time</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>It may also be useful to know the distance to the wall.  We will used a signed distance, which also tells us which side of the wall we are on</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">distance</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Hwall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
<span class="n">distance</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Vwall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">distance</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">w</span><span class="o">::</span><span class="kt">Wall</span><span class="p">)</span><span class="o">=</span><span class="n">distance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Another thing you want to know is, where will it hit?</p>
<p>At this point we can take advantage of the class heirarchy, and define one function (aka method) that works for all walls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">impact_location</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Wall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">impact_time</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="o">-</span><span class="n">b</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Because of how we structured things, we do not need separate <code class="docutils literal notranslate"><span class="pre">impact_location</span></code> methods for <code class="docutils literal notranslate"><span class="pre">Hwall</span></code>’s and <code class="docutils literal notranslate"><span class="pre">Vwall</span></code>’s.  This greatly simplifies our code.  It also means when we are debugging or refactoring we only need to make changes in one place</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@show</span><span class="w"> </span><span class="n">b2</span><span class="o">=</span><span class="n">Ball</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">impact_location</span><span class="p">(</span><span class="n">Hwall</span><span class="p">(</span><span class="mf">4.</span><span class="p">),</span><span class="n">b2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As I said, both <code class="docutils literal notranslate"><span class="pre">Hwall</span></code> and <code class="docutils literal notranslate"><span class="pre">Vwall</span></code> now can work with <code class="docutils literal notranslate"><span class="pre">impact_location</span></code>.  This structure is sometimes referred to as <em>inheritance</em>.  The subclasses inherit properties from the superclass.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">impact_location</span><span class="p">(</span><span class="n">Vwall</span><span class="p">(</span><span class="mf">4.</span><span class="p">),</span><span class="n">b2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="dealing-with-roundoff">
<h4>Dealing with Roundoff<a class="headerlink" href="#dealing-with-roundoff" title="Permalink to this heading">#</a></h4>
<p>Our <code class="docutils literal notranslate"><span class="pre">impact_location</span></code> function has a problem.  In exact arithmetic it will put the ball exactly on the wall.  Unfortunately, due to machine precision it will typically be a bit off.  We want to make sure the ball stays in the billiard.  If roundoff puts the ball outside the billiard it can escape.</p>
<p>We will deal with this in the future – but it is good to keep in mind that it will be an issue at some point.</p>
</section>
</section>
<section id="circular-walls">
<h3>Circular Walls<a class="headerlink" href="#circular-walls" title="Permalink to this heading">#</a></h3>
<p>We could then add another wall type.  Say a circle at the origin of radius <span class="math notranslate nohighlight">\(r\)</span>.  To find the impact time we first define the initial time as <span class="math notranslate nohighlight">\(t_0=\)</span> <code class="docutils literal notranslate"><span class="pre">b.t</span></code>, and the initial <span class="math notranslate nohighlight">\(x_0=\)</span> <code class="docutils literal notranslate"><span class="pre">b.x</span></code>, and so on.  We would then have <span class="math notranslate nohighlight">\(x(t)=x_0+(t-t_0) v_x\)</span> and <span class="math notranslate nohighlight">\(y(t)=y_0+(t-t_0) v_y\)</span>.  We then solve <span class="math notranslate nohighlight">\(x^2+y^2=r^2.\)</span>  This gives us a quadratic equation for <span class="math notranslate nohighlight">\(\delta t=t-t_0\)</span>.</p>
<div class="amsmath math notranslate nohighlight" id="equation-dff53d47-2d90-4526-8f48-f6517304282b">
<span class="eqno">(94)<a class="headerlink" href="#equation-dff53d47-2d90-4526-8f48-f6517304282b" title="Permalink to this equation">#</a></span>\[\begin{align}
r^2&amp;= x_0^2+y_0^2+ 2\delta t (v_x x_0+ v_y y_0) + \delta t^2 (v_x^2+v_y^2)
\end{align}\]</div>
<p>which gives</p>
<div class="amsmath math notranslate nohighlight" id="equation-f383738d-2e04-41eb-b671-f8efbf3e9f7d">
<span class="eqno">(95)<a class="headerlink" href="#equation-f383738d-2e04-41eb-b671-f8efbf3e9f7d" title="Permalink to this equation">#</a></span>\[\begin{align}
\delta t&amp;= \frac{-\vec{v}\cdot \vec{r}_0\pm\sqrt{(\vec{v}\cdot \vec{r}_0)^2-(|r_0|^2-r^2)|v|^2}}{|v|^2}.
\end{align}\]</div>
<p>There are then a number of cases:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(|r_0|&lt;r\)</span> – we are inside the circle.  There will always be two solutions, one at positive <span class="math notranslate nohighlight">\(\delta t\)</span>, and one at negative <span class="math notranslate nohighlight">\(\delta t\)</span>.  We want the one with positive <span class="math notranslate nohighlight">\(\delta t\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(|r_0|&gt;r\)</span> and <span class="math notranslate nohighlight">\((\vec{v}\cdot \vec{r}_0)^2&lt;4(|r_0|^2-r^2)|v|^2\)</span>.  We are outside of the circle, but moving on a trajectory which never impacts the circle – the impact time should be infinite</p></li>
<li><p><span class="math notranslate nohighlight">\(|r_0|&gt;r\)</span> and <span class="math notranslate nohighlight">\((\vec{v}\cdot \vec{r}_0)^2&gt;4(|r_0|^2-r^2)|v|^2\)</span>.  We are outside of the circle, and the trajectory intersects the circle twice.</p>
<ul>
<li><p>If <span class="math notranslate nohighlight">\(\vec{v}\cdot \vec{r}_0&gt;0\)</span> the impact times are both negative:  we can simply set the time to infinity</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\vec{v}\cdot \vec{r}_0&gt;0\)</span> the impact times are both negative: we want the smaller one</p></li>
</ul>
</li>
</ul>
<p>The multiple cases are somewhat tedious.  There is a simpler approach though:</p>
<ol class="arabic simple">
<li><p>First calculate the discriminant <span class="math notranslate nohighlight">\(d=(\vec{v}\cdot\vec r_0)^2-(|r_0|^2-r^2)|v|^2\)</span></p>
<ul class="simple">
<li><p>if the discriminant is negative, the ball is never going to hit the object, so <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">Inf</span></code></p></li>
</ul>
</li>
<li><p>Next calculate <span class="math notranslate nohighlight">\(\delta t_+\)</span> and <span class="math notranslate nohighlight">\(\delta t_-\)</span>.</p>
<ul class="simple">
<li><p>if they are both negative, return <code class="docutils literal notranslate"><span class="pre">Inf</span></code>.  Otherwise return the smallest postive time</p></li>
</ul>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># load in package which gives us dot product x⋅y</span>
<span class="k">using</span><span class="w"> </span><span class="n">LinearAlgebra</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c">#?dot</span>
</pre></div>
</div>
</div>
</div>
<p>You can type the “dot” in <span class="math notranslate nohighlight">\(x\cdot y\)</span> by typin <code class="docutils literal notranslate"><span class="pre">\cdot</span></code> and then hitting the tab key.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">⋅</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">mutable</span><span class="w"> </span><span class="k">struct</span> <span class="kt">Cwall</span><span class="w"> </span><span class="o">&lt;:</span><span class="kt">Wall</span>
<span class="w">    </span><span class="n">r</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">distance</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Cwall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span>
<span class="w">    </span><span class="n">r</span><span class="o">=</span><span class="n">norm</span><span class="p">(</span><span class="n">get_r</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">w</span><span class="o">.</span><span class="n">r</span><span class="o">-</span><span class="n">r</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">impact_time</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Cwall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Unpack variables from inputs</span>
<span class="w">    </span><span class="n">t0</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">t</span>
<span class="w">    </span><span class="n">r0</span><span class="o">=</span><span class="n">get_r</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="o">=</span><span class="n">get_v</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">r</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">r</span>
<span class="w">    </span><span class="c"># Call function which uses those inputs to calculate impact time</span>
<span class="w">    </span><span class="n">t0</span><span class="o">+</span><span class="n">circ_time</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">circ_time</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Calculate the various terms in our expression</span>
<span class="w">    </span><span class="n">r0dotv</span><span class="o">=</span><span class="n">r0⋅v</span>
<span class="w">    </span><span class="n">vsq</span><span class="o">=</span><span class="n">v⋅v</span>
<span class="w">    </span><span class="n">r0sq</span><span class="o">=</span><span class="n">r0⋅r0</span>
<span class="w">    </span><span class="n">discriminant</span><span class="o">=</span><span class="n">r0dotv</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="n">r0sq</span><span class="p">)</span><span class="o">*</span><span class="n">vsq</span><span class="w">  </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">discriminant</span><span class="o">&lt;</span><span class="mi">0</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Inf</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">times</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="n">r0dotv</span><span class="o">-</span><span class="n">sqrt</span><span class="p">(</span><span class="n">discriminant</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">vsq</span><span class="p">),(</span><span class="o">-</span><span class="n">r0dotv</span><span class="o">+</span><span class="n">sqrt</span><span class="p">(</span><span class="n">discriminant</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">vsq</span><span class="p">)]</span>
<span class="w">    </span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="o">=</span><span class="n">minmax</span><span class="p">(</span><span class="n">times</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">t2</span><span class="o">&lt;=</span><span class="mi">0</span><span class="w"> </span><span class="c"># both times are negative</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Inf</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">t1</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="c"># both times are positive</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">t1</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="c"># t1&lt;0 and t2&gt;0</span>
<span class="k">end</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">This is the tedious way to calculate the collision time with a circle</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span><span class="w"> </span><span class="n">circ_time_tedious</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Calculate the various terms in our expression</span>
<span class="w">    </span><span class="n">r0dotv</span><span class="o">=</span><span class="n">r0⋅v</span>
<span class="w">    </span><span class="n">vsq</span><span class="o">=</span><span class="n">v⋅v</span>
<span class="w">    </span><span class="n">r0sq</span><span class="o">=</span><span class="n">r0⋅r0</span>
<span class="w">    </span><span class="n">discriminant</span><span class="o">=</span><span class="n">r0dotv</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="n">r0sq</span><span class="p">)</span><span class="o">*</span><span class="n">vsq</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># Now lets just go through each case</span>
<span class="w">    </span><span class="c">#</span>
<span class="w">    </span><span class="c"># Case 1: We are inside the Circle</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">r0sq</span><span class="o">&lt;</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">discriminant</span><span class="p">)</span><span class="o">-</span><span class="n">r0dotv</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">vsq</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="c"># Case 1b: We are on the circle</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">r0sq</span><span class="o">==</span><span class="n">r</span><span class="o">^</span><span class="mi">2</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">r0dotv</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="c">#moving away</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Inf</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">r0dotv</span><span class="o">/</span><span class="n">vsq</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="c"># Case 2: Outside the circle, but do not hit it</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">discriminant</span><span class="o">&lt;</span><span class="mi">0</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Inf</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="c"># Case 3: Outside, but moving away</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">r0dotv</span><span class="o">&gt;</span><span class="mi">0</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Inf</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="c"># Case 4: Outside, and moving towards</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">r0dotv</span><span class="o">-</span><span class="n">sqrt</span><span class="p">(</span><span class="n">discriminant</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">vsq</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">cw1</span><span class="o">=</span><span class="n">Cwall</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">b1</span><span class="o">=</span><span class="n">Ball</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
<span class="n">il</span><span class="o">=</span><span class="n">impact_location</span><span class="p">(</span><span class="n">cw1</span><span class="p">,</span><span class="n">b1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">il⋅il</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">impact_time</span><span class="p">(</span><span class="n">cw1</span><span class="p">,</span><span class="n">b1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="deciding-which-wall-to-collide-off-of">
<h2>Deciding which wall to collide off of<a class="headerlink" href="#deciding-which-wall-to-collide-off-of" title="Permalink to this heading">#</a></h2>
<p>Now a billiard will generically have multiple walls.  Lets make a function which produces a rectangular billiard:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Recall:  The Billiard class is defined as</span>
<span class="k">struct</span> <span class="kt">Billiard</span>
<span class="w">    </span><span class="n">walls</span><span class="w"> </span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Wall</span><span class="p">}</span>
<span class="w">    </span><span class="n">ball</span><span class="w"> </span><span class="o">::</span><span class="kt">Ball</span>
<span class="w">    </span><span class="n">boundingbox</span><span class="w"> </span><span class="c"># x1,y1,x2,y2 = corners of a rectangle</span>
<span class="k">end</span>

<span class="c"># given the dimensions, and the coordinates of the ball, make a Billiard</span>

<span class="k">function</span><span class="w"> </span><span class="n">rectangular_billiard</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">ball_x</span><span class="p">,</span><span class="n">ball_y</span><span class="p">,</span><span class="n">ball_vx</span><span class="p">,</span><span class="n">ball_vy</span><span class="p">,</span><span class="n">ball_t</span><span class="p">)</span>
<span class="w">    </span><span class="n">Billiard</span><span class="p">([</span><span class="n">Hwall</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">Hwall</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="o">-</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">)],</span>
<span class="w">        </span><span class="n">Ball</span><span class="p">(</span><span class="n">ball_x</span><span class="p">,</span><span class="n">ball_y</span><span class="p">,</span><span class="n">ball_vx</span><span class="p">,</span><span class="n">ball_vy</span><span class="p">,</span><span class="n">ball_t</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="k">end</span>

<span class="c"># If you don&#39;t give a location/speed for the ball, just put it at the origin</span>

<span class="n">rectangular_billiard</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">)</span><span class="o">=</span><span class="n">rectangular_billiard</span><span class="p">(</span>
<span class="w">    </span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="n">rectangular_billiard</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span>
<span class="w">    </span><span class="n">ball_x</span><span class="p">,</span><span class="n">ball_y</span><span class="p">,</span><span class="n">ball_vx</span><span class="p">,</span><span class="n">ball_vy</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="n">rectangular_billiard</span><span class="p">(</span>
<span class="w">    </span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">ball_x</span><span class="p">,</span><span class="n">ball_y</span><span class="p">,</span><span class="n">ball_vx</span><span class="p">,</span><span class="n">ball_vy</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">billiard1</span><span class="o">=</span><span class="n">rectangular_billiard</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">billiard1</span><span class="o">.</span><span class="n">walls</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b1</span><span class="o">=</span><span class="n">billiard1</span><span class="o">.</span><span class="n">ball</span>
<span class="n">set_v!</span><span class="p">(</span><span class="n">b1</span><span class="p">,[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.</span><span class="p">])</span>
<span class="n">b1</span><span class="o">.</span><span class="n">t</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">b1</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how we get all of the times for the collision of the ball with the walls</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">its</span><span class="o">=</span><span class="p">[</span><span class="n">impact_time</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">b1</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">billiard1</span><span class="o">.</span><span class="n">walls</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We now want to extract the smallest time which is greater than the current time</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    argmin_abovetheshold(list,threshold)</span>

<span class="s">finds the location in `list`, which contains the smallest element which is greater than `threshold`.  </span>
<span class="s">Returns `0` if there is no element above `threshold`.  If there is a tie, it returns the one that </span>
<span class="s">occurs first in the list.</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span><span class="w"> </span><span class="n">argmin_abovetheshold</span><span class="p">(</span><span class="n">list</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span>
<span class="w">    </span><span class="n">location</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="c"># this will store the result</span>
<span class="w">    </span><span class="n">currentmin</span><span class="o">=</span><span class="nb">Inf</span><span class="w"> </span><span class="c"># this will keep track of the smallest element we have found</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="n">list</span><span class="p">)</span><span class="w">  </span><span class="c">#loop over the elements of the list</span>
<span class="w">        </span><span class="n">value</span><span class="o">=</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">value</span><span class="o">&gt;</span><span class="n">threshold</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">value</span><span class="o">&lt;</span><span class="n">currentmin</span><span class="w"> </span><span class="c"># The &amp;&amp; is the logical `and`</span>
<span class="w">            </span><span class="n">location</span><span class="o">=</span><span class="n">i</span>
<span class="w">            </span><span class="n">currentmin</span><span class="o">=</span><span class="n">value</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">location</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">argmin_abovetheshold</span><span class="p">(</span><span class="n">its</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">argmin_abovetheshold</span><span class="p">(</span><span class="n">its</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-velocity-after-collision">
<h2>Setting Velocity after collision<a class="headerlink" href="#setting-velocity-after-collision" title="Permalink to this heading">#</a></h2>
<p>After a collision, the component of the velocity which is normal to the surface should be reversed, while the parallel component should be unchanged.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">reflect</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">normal</span><span class="p">)</span><span class="o">=</span><span class="n">vec</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">vec⋅normal</span><span class="p">)</span><span class="o">*</span><span class="n">normal</span><span class="o">/</span><span class="p">(</span><span class="n">normal⋅normal</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">reflect</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>So we need to extract the normal vector from our walls</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">normal</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Hwall</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">normal</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Vwall</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">normal</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Cwall</span><span class="p">,</span><span class="n">r</span><span class="p">)</span><span class="o">=</span><span class="n">r</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now for a collision, we will first move the ball to the collision point, then calculate/set the velocity.  Here is a function which will calculate the new velocity</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">newvelocity</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Wall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span>
<span class="w">    </span><span class="n">r</span><span class="o">=</span><span class="n">get_r</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">n</span><span class="o">=</span><span class="n">normal</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="o">=</span><span class="n">get_v</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">set_newvelocity!</span><span class="p">(</span><span class="n">w</span><span class="o">::</span><span class="kt">Wall</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="o">=</span><span class="n">newvelocity</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">set_v!</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">b</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">time_evolve!</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="n">r</span><span class="o">=</span><span class="n">get_r</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">v</span><span class="o">=</span><span class="n">get_v</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">t0</span><span class="o">=</span><span class="n">get_t</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">newr</span><span class="o">=</span><span class="n">r</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">t0</span><span class="p">)</span>
<span class="w">    </span><span class="n">set_r!</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">newr</span><span class="p">)</span>
<span class="w">    </span><span class="n">set_t!</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="k">end</span>

<span class="c"># this is the naive implementation of our collide method</span>
<span class="c"># -- it is vulnerable to round-off error though</span>
<span class="k">function</span><span class="w"> </span><span class="n">simplecollide!</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">w</span><span class="o">::</span><span class="kt">Wall</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="n">start_r</span><span class="o">=</span><span class="n">get_r</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">time_evolve!</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">b</span>
<span class="k">end</span>

<span class="c"># here is a version which deals with round-off error</span>
<span class="k">function</span><span class="w"> </span><span class="n">collide!</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">,</span><span class="n">w</span><span class="o">::</span><span class="kt">Wall</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="n">start_r</span><span class="o">=</span><span class="n">get_r</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">initial_distance</span><span class="o">=</span><span class="n">distance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="w">    </span><span class="n">time_evolve!</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="n">final_distance</span><span class="o">=</span><span class="n">distance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="c"># should be zero, unless there is roundoff error</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">initial_distance</span><span class="o">*</span><span class="n">final_distance</span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="c"># we have overshot the wall</span>
<span class="w">        </span><span class="n">n</span><span class="o">=</span><span class="n">normal</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">get_r</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
<span class="w">        </span><span class="n">r</span><span class="o">=</span><span class="n">get_r</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">        </span><span class="n">v</span><span class="o">=</span><span class="n">get_v</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">        </span><span class="n">new_r</span><span class="o">=</span><span class="n">r</span><span class="o">-</span><span class="n">v</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">abs</span><span class="p">(</span><span class="n">final_distance</span><span class="o">/</span><span class="p">(</span><span class="n">n⋅v</span><span class="p">))</span><span class="w"> </span><span class="c"># go backward along trajectory twice the amount that we have overshot</span>
<span class="w">        </span><span class="n">set_r!</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">new_r</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">b</span>
<span class="k">end</span>
<span class="w">    </span>
<span class="k">function</span><span class="w"> </span><span class="n">collision_evolve!</span><span class="p">(</span><span class="n">billiard</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="n">Billiard</span><span class="p">;</span><span class="n">teps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">)</span>
<span class="w">    </span><span class="n">walls</span><span class="o">=</span><span class="n">billiard</span><span class="o">.</span><span class="n">walls</span>
<span class="w">    </span><span class="n">ball</span><span class="o">=</span><span class="n">billiard</span><span class="o">.</span><span class="n">ball</span>
<span class="w">    </span><span class="n">collisiontimes</span><span class="o">=</span><span class="p">[</span><span class="n">impact_time</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">ball</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">walls</span><span class="p">]</span>
<span class="w">    </span><span class="n">next_collision_index</span><span class="o">=</span><span class="n">argmin_abovetheshold</span><span class="p">(</span><span class="n">collisiontimes</span><span class="p">,</span><span class="n">ball</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="n">collide!</span><span class="p">(</span><span class="n">ball</span><span class="p">,</span><span class="n">walls</span><span class="p">[</span><span class="n">next_collision_index</span><span class="p">],</span><span class="n">collisiontimes</span><span class="p">[</span><span class="n">next_collision_index</span><span class="p">]</span><span class="o">-</span><span class="n">teps</span><span class="p">)</span>
<span class="w">    </span><span class="n">set_newvelocity!</span><span class="p">(</span><span class="n">walls</span><span class="p">[</span><span class="n">next_collision_index</span><span class="p">],</span><span class="n">ball</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">billiard</span>
<span class="k">end</span><span class="w"> </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">billiard1</span><span class="o">=</span><span class="n">rectangular_billiard</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span>
<span class="n">b1</span><span class="o">=</span><span class="n">billiard1</span><span class="o">.</span><span class="n">ball</span>
<span class="n">set_v!</span><span class="p">(</span><span class="n">b1</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">collision_evolve!</span><span class="p">(</span><span class="n">billiard1</span><span class="p">;</span><span class="n">teps</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">collision_evolve!</span><span class="p">(</span><span class="n">billiard1</span><span class="p">;</span><span class="n">teps</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">collision_evolve!</span><span class="p">(</span><span class="n">billiard1</span><span class="p">;</span><span class="n">teps</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">collision_evolve!</span><span class="p">(</span><span class="n">billiard1</span><span class="p">;</span><span class="n">teps</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="main-loop">
<h2>Main loop<a class="headerlink" href="#main-loop" title="Permalink to this heading">#</a></h2>
<p>Now we can write code which repeatedly has the ball bouncing off of walls until some condition is sattisfied.  That condition could be a certain number of bounces, or a time.  We could also check to see if the ball returns to its starting conditions – in which case we have periodic motion and things will just keep repeating.</p>
<p>Lets make it simple, and just do a fixed number of collisions.  Lets store the date in its own object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">mutable</span><span class="w"> </span><span class="k">struct</span> <span class="kt">Billiard_Simulation</span>
<span class="w">    </span><span class="n">billiard</span><span class="w"> </span><span class="o">::</span><span class="kt">Billiard</span>
<span class="w">    </span><span class="n">events</span><span class="w"> </span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Ball</span><span class="p">}</span>
<span class="k">end</span>

<span class="n">Base</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">Billiard_Simulation</span><span class="p">)</span><span class="o">=</span><span class="n">length</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>

<span class="n">Base</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="kt">IO</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Billiard_Simulation</span><span class="p">)</span><span class="o">=</span><span class="n">print</span><span class="p">(</span><span class="n">io</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;Billiard_Simulation &lt;&lt;n=&quot;</span><span class="o">*</span><span class="n">repr</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">*</span>
<span class="w">    </span><span class="s">&quot; t=&quot;</span><span class="o">*</span><span class="n">repr</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">billiard</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="s">&quot;&gt;&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we choose to store the events as an array of <code class="docutils literal notranslate"><span class="pre">Ball</span></code> objects, then we will need to create a way to copy balls:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">Base</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">Ball</span><span class="p">)</span><span class="o">=</span><span class="n">Ball</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b1</span><span class="o">=</span><span class="n">Ball</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b2</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
<span class="n">b3</span><span class="o">=</span><span class="n">b1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b2</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="mf">5.</span>
<span class="n">b1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b3</span><span class="o">.</span><span class="n">y</span><span class="o">=</span><span class="mf">7.</span>
<span class="n">b1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">b</span><span class="o">::</span><span class="kt">Billiard</span><span class="p">,</span><span class="n">n</span><span class="o">::</span><span class="kt">Integer</span><span class="p">)</span>
<span class="w">    </span><span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ball</span><span class="p">)]</span>
<span class="w">    </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span>
<span class="w">        </span><span class="n">collision_evolve!</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="w">        </span><span class="n">push!</span><span class="p">(</span><span class="n">events</span><span class="p">,</span><span class="n">copy</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ball</span><span class="p">))</span>
<span class="w">        </span><span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Billiard_Simulation</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">events</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">rectangular_billiard</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">100</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="n">s1</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Writing that simulation was very easy.  Now we just need to make some visualizations.  The notation here may seem a bit complicated, but it is much simpler than what you did with the Duffing oscillator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Master function for visualizing</span>
<span class="c"># -- creates new plot object, and then calls visualize!</span>
<span class="k">function</span><span class="w"> </span><span class="n">visualize</span><span class="p">(</span><span class="n">opts</span><span class="o">...</span><span class="p">;</span><span class="n">namedopts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">viz</span><span class="o">=</span><span class="n">plot</span><span class="p">()</span>
<span class="w">    </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="p">,</span><span class="n">opts</span><span class="o">...</span><span class="p">;</span><span class="n">namedopts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">viz</span>
<span class="k">end</span>

<span class="c">#Visualizing a Billiard Simulation</span>
<span class="k">function</span><span class="w"> </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="o">::</span><span class="kt">Plots</span><span class="o">.</span><span class="n">Plot</span><span class="p">,</span><span class="n">s</span><span class="o">::</span><span class="kt">Billiard_Simulation</span><span class="p">;</span>
<span class="w">        </span><span class="n">walloptions</span><span class="o">=</span><span class="p">[],</span><span class="n">balloptions</span><span class="o">=</span><span class="p">[])</span>
<span class="w">    </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">billiard</span><span class="p">;</span><span class="n">walloptions</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">events</span><span class="p">;</span><span class="n">balloptions</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">viz</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="o">::</span><span class="kt">Plots</span><span class="o">.</span><span class="n">Plot</span><span class="p">,</span><span class="n">b</span><span class="o">::</span><span class="kt">Billiard</span><span class="p">;</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">walls</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">walls</span>
<span class="w">    </span><span class="n">bbox</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">boundingbox</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">walls</span>
<span class="w">        </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">bbox</span><span class="p">;</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">viz</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="o">::</span><span class="kt">Plots</span><span class="o">.</span><span class="n">Plot</span><span class="p">,</span><span class="n">w</span><span class="o">::</span><span class="kt">Hwall</span><span class="p">,</span><span class="n">bbox</span><span class="p">;</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="o">=</span><span class="n">bbox</span>
<span class="w">    </span><span class="n">y</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">y</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">viz</span><span class="p">,[</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">],[</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">];</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="o">::</span><span class="kt">Plots</span><span class="o">.</span><span class="n">Plot</span><span class="p">,</span><span class="n">w</span><span class="o">::</span><span class="kt">Vwall</span><span class="p">,</span><span class="n">bbox</span><span class="p">;</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="o">=</span><span class="n">bbox</span>
<span class="w">    </span><span class="n">x</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">x</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">viz</span><span class="p">,[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">],[</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="p">];</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="o">::</span><span class="kt">Plots</span><span class="o">.</span><span class="n">Plot</span><span class="p">,</span><span class="n">w</span><span class="o">::</span><span class="kt">Cwall</span><span class="p">,</span><span class="n">bbox</span><span class="p">;</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">r</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">r</span>
<span class="w">    </span><span class="n">xdata</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">θ</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="o">/</span><span class="mi">100</span><span class="o">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="p">]</span>
<span class="w">    </span><span class="n">ydata</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">θ</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="o">/</span><span class="mi">100</span><span class="o">:</span><span class="mi">2</span><span class="o">*</span><span class="nb">pi</span><span class="p">]</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">viz</span><span class="p">,</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">;</span><span class="n">aspectratio</span><span class="o">=</span><span class="ss">:equal</span><span class="p">,</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="o">::</span><span class="kt">Plots</span><span class="o">.</span><span class="n">Plot</span><span class="p">,</span><span class="n">trajectory</span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Ball</span><span class="p">};</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">xdata</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">trajectory</span><span class="p">]</span>
<span class="w">    </span><span class="n">ydata</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">trajectory</span><span class="p">]</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">viz</span><span class="p">,</span><span class="n">xdata</span><span class="p">,</span><span class="n">ydata</span><span class="p">;</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">s1</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">rectangular_billiard</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">100</span><span class="p">);</span>
<span class="n">viz</span><span class="o">=</span><span class="n">visualize</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span>
<span class="w">    </span><span class="n">walloptions</span><span class="o">=</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">balloptions</span><span class="o">=</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;x0=(0.25,0.25),v0=(1,-1)&quot;</span><span class="p">,</span><span class="n">linecolor</span><span class="o">=</span><span class="ss">:blue</span><span class="p">));</span>
<span class="n">display</span><span class="p">(</span><span class="n">viz</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">s2</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">rectangular_billiard</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="o">-</span><span class="mf">0.801</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">100</span><span class="p">);</span>
<span class="n">visualize!</span><span class="p">(</span><span class="n">viz</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span>
<span class="w">    </span><span class="n">walloptions</span><span class="o">=</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="n">balloptions</span><span class="o">=</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;x0=(0.2,0.25),v0=(1,-0.8)&quot;</span><span class="p">,</span><span class="n">linecolor</span><span class="o">=</span><span class="ss">:red</span><span class="p">));</span>
<span class="n">display</span><span class="p">(</span><span class="n">viz</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="poincare-sections">
<h3>Poincare sections<a class="headerlink" href="#poincare-sections" title="Permalink to this heading">#</a></h3>
<p>When we were looking at the driven non-linear oscillator we defined the <em>Poincare Section</em> to be a plot of phase space at some particular periodic time.  The analogous quantity for Billiards is to plot phase space at some particular <em>event</em>.  The most obvious is every time the ball hits a wall.  Given that the boundary is a line, and the magnitude of the velocity is fixed, phase space is two dimensional (when the ball is constrained to be on the boundary).  A convenient way to plot things is to use polar coordinates, and plot the direction of the velocity vs the direction of the position.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">poincare</span><span class="p">(</span><span class="n">s</span><span class="o">::</span><span class="kt">Billiard_Simulation</span><span class="p">;</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">θ</span><span class="o">=</span><span class="p">[</span><span class="n">atan</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">s</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]]</span>
<span class="w">    </span><span class="n">ϕ</span><span class="o">=</span><span class="p">[</span><span class="n">atan</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">s</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]]</span>
<span class="w">    </span><span class="n">scatter</span><span class="p">(</span><span class="n">θ</span><span class="p">,</span><span class="n">ϕ</span><span class="p">;</span><span class="n">xlabel</span><span class="o">=</span><span class="s">&quot;tan⁻¹(y/x)&quot;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;tan⁻¹(vy/vx)&quot;</span><span class="p">,</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">poincare!</span><span class="p">(</span><span class="n">s</span><span class="o">::</span><span class="kt">Billiard_Simulation</span><span class="p">;</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="w">    </span><span class="n">θ</span><span class="o">=</span><span class="p">[</span><span class="n">atan</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">s</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]]</span>
<span class="w">    </span><span class="n">ϕ</span><span class="o">=</span><span class="p">[</span><span class="n">atan</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">vx</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">s</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]]</span>
<span class="w">    </span><span class="n">scatter!</span><span class="p">(</span><span class="n">θ</span><span class="p">,</span><span class="n">ϕ</span><span class="p">;</span><span class="n">xlabel</span><span class="o">=</span><span class="s">&quot;tan⁻¹(y/x)&quot;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;tan⁻¹(vy/vx)&quot;</span><span class="p">,</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">poincare</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="animation">
<h2>Animation<a class="headerlink" href="#animation" title="Permalink to this heading">#</a></h2>
<p>It is clear that we need to make some sort of animation of our data.  We could use <code class="docutils literal notranslate"><span class="pre">Plots.jl</span></code> or <code class="docutils literal notranslate"><span class="pre">GLMakie</span></code>.  Since we already loaded <code class="docutils literal notranslate"><span class="pre">Plots.jl</span></code>, lets just use it.  (Though to be honest, I prefer the GLMakie animations)</p>
<p>The simplest animation would simply display the trajectories event by event.  A more sophisticated one would generate a time series from the events</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">eventanimate</span><span class="p">(</span><span class="n">s</span><span class="o">::</span><span class="kt">Billiard_Simulation</span><span class="p">;</span><span class="n">traillength</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="w">        </span><span class="c"># print out a message to let the user know things are starting</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="s">&quot;Animating Billiard&quot;</span>
<span class="w">    </span><span class="c"># Make a progress bar</span>
<span class="w">    </span><span class="n">billiard</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">billiard</span>
<span class="w">    </span><span class="n">events</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">events</span>
<span class="w">    </span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">events</span><span class="p">]</span>
<span class="w">    </span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">y</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">events</span><span class="p">]</span>
<span class="w">    </span><span class="n">times</span><span class="o">=</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">t</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">events</span><span class="p">]</span>
<span class="w">    </span><span class="n">progress_meter</span><span class="o">=</span><span class="n">Progress</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">times</span><span class="p">),</span><span class="n">desc</span><span class="o">=</span><span class="s">&quot;Generating frames: &quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">anim</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nd">@animate</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eachindex</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
<span class="w">        </span><span class="n">update!</span><span class="p">(</span><span class="n">progress_meter</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="c"># Generate path</span>
<span class="w">        </span><span class="n">x_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="n">y_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="n">plt</span><span class="o">=</span><span class="n">visualize</span><span class="p">(</span><span class="n">billiard</span><span class="p">)</span>
<span class="w">        </span><span class="n">Plots</span><span class="o">.</span><span class="n">plot!</span><span class="p">(</span><span class="n">x_path</span><span class="p">,</span><span class="w"> </span><span class="n">y_path</span><span class="p">,</span><span class="w"> </span><span class="n">linecolor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">:black</span><span class="p">,</span>
<span class="w">            </span><span class="n">xlabel</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>


<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="c"># Generate chem-trails</span>
<span class="w">            </span><span class="n">x_trail</span><span class="o">=</span><span class="n">reverse</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="n">traillength</span><span class="p">)</span><span class="o">:</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="n">y_trail</span><span class="o">=</span><span class="n">reverse</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="n">traillength</span><span class="p">)</span><span class="o">:</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="n">n</span><span class="o">=</span><span class="n">length</span><span class="p">(</span><span class="n">x_trail</span><span class="p">)</span>
<span class="w">            </span><span class="n">widths</span><span class="w"> </span><span class="o">=</span><span class="n">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">            </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>

<span class="w">            </span><span class="n">Plots</span><span class="o">.</span><span class="n">plot!</span><span class="p">(</span><span class="n">x_trail</span><span class="p">,</span><span class="n">y_trail</span><span class="p">,</span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="n">widths</span><span class="p">,</span>
<span class="w">                </span><span class="n">seriesalpha</span><span class="w"> </span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span>
<span class="w">        </span><span class="n">Plots</span><span class="o">.</span><span class="n">scatter!</span><span class="p">(</span>
<span class="w">            </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
<span class="w">            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">:black</span><span class="p">,</span>
<span class="w">            </span><span class="n">markersize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">            </span><span class="n">markerstrokewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">markerstrokecolor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">:orange</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span>
<span class="w">        </span><span class="n">Plots</span><span class="o">.</span><span class="n">annotate!</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;time=&quot;</span><span class="o">*</span><span class="n">string</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="n">digits</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">Plots</span><span class="o">.</span><span class="n">gif</span><span class="p">(</span><span class="n">anim</span><span class="p">,</span><span class="w"> </span><span class="n">fps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c">#eventanimate(s1)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c">#eventanimate(s2)</span>
</pre></div>
</div>
</div>
</div>
<p>Those actually look pretty good.  Nonetheless, if we do want to more fine-grain the motion, here is how I would extract a time series.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">timeseries</span><span class="p">(</span><span class="n">s</span><span class="o">::</span><span class="kt">Billiard_Simulation</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
<span class="w">    </span><span class="n">events</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">events</span>
<span class="w">    </span><span class="n">t</span><span class="o">=</span><span class="n">events</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">t</span>
<span class="w">    </span><span class="n">x</span><span class="o">=</span><span class="n">events</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
<span class="w">    </span><span class="n">y</span><span class="o">=</span><span class="n">events</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
<span class="w">    </span><span class="n">xlist</span><span class="o">=</span><span class="kt">Array</span><span class="p">{</span><span class="kt">typeof</span><span class="p">(</span><span class="kt">x</span><span class="p">)}(</span><span class="nb">undef</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c"># make an empty array</span>
<span class="w">    </span><span class="n">ylist</span><span class="o">=</span><span class="kt">Array</span><span class="p">{</span><span class="kt">typeof</span><span class="p">(</span><span class="kt">x</span><span class="p">)}(</span><span class="nb">undef</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">times</span><span class="o">=</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Float64</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="n">start_x</span><span class="o">=</span><span class="n">events</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
<span class="w">        </span><span class="n">start_y</span><span class="o">=</span><span class="n">events</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>
<span class="w">        </span><span class="n">start_t</span><span class="o">=</span><span class="n">get_t</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
<span class="w">        </span><span class="n">end_t</span><span class="o">=</span><span class="n">get_t</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
<span class="w">        </span><span class="n">vx</span><span class="o">=</span><span class="n">events</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">vx</span>
<span class="w">        </span><span class="n">vy</span><span class="o">=</span><span class="n">events</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">vy</span>
<span class="w">        </span><span class="n">push!</span><span class="p">(</span><span class="n">xlist</span><span class="p">,</span><span class="n">start_x</span><span class="p">)</span>
<span class="w">        </span><span class="n">push!</span><span class="p">(</span><span class="n">ylist</span><span class="p">,</span><span class="n">start_y</span><span class="p">)</span>
<span class="w">        </span><span class="n">push!</span><span class="p">(</span><span class="n">times</span><span class="p">,</span><span class="n">start_t</span><span class="p">)</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">t</span><span class="o">&lt;</span><span class="n">end_t</span>
<span class="w">            </span><span class="n">x</span><span class="o">=</span><span class="n">start_x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">start_t</span><span class="p">)</span><span class="o">*</span><span class="n">vx</span>
<span class="w">            </span><span class="n">y</span><span class="o">=</span><span class="n">start_y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">start_t</span><span class="p">)</span><span class="o">*</span><span class="n">vy</span>
<span class="w">            </span><span class="n">push!</span><span class="p">(</span><span class="n">xlist</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
<span class="w">            </span><span class="n">push!</span><span class="p">(</span><span class="n">ylist</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="w">            </span><span class="n">push!</span><span class="p">(</span><span class="n">times</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">            </span><span class="n">t</span><span class="o">+=</span><span class="n">dt</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span><span class="w">    </span>
<span class="w">    </span><span class="p">(</span><span class="n">billiard</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">billiard</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">xlist</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">ylist</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c"># Since it takes some time to generate the frames we want to show</span>
<span class="c">#  a progress bar.  This is good practice for any slow code.</span>
<span class="k">using</span><span class="w"> </span><span class="n">ProgressMeter</span>

<span class="s">&quot;&quot;&quot;</span>
<span class="s">    animatebilliard(billiard,x,y,times)</span>

<span class="s">Generates an animation of a billiard.</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="k">function</span><span class="w"> </span><span class="n">animatebilliard</span><span class="p">(</span><span class="n">billiard</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">times</span><span class="p">;</span><span class="n">traillength</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="w">    </span>
<span class="w">    </span><span class="c"># print out a message to let the user know things are starting</span>
<span class="w">    </span><span class="nd">@info</span><span class="w"> </span><span class="s">&quot;Animating Billiard&quot;</span>
<span class="w">    </span><span class="c"># Make a progress bar</span>
<span class="w">    </span><span class="n">progress_meter</span><span class="o">=</span><span class="n">Progress</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">times</span><span class="p">),</span><span class="n">desc</span><span class="o">=</span><span class="s">&quot;Generating frames: &quot;</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Loop to generate the frames</span>
<span class="w">    </span><span class="c"># the `@animate` is a macro defined by Plots.jl</span>
<span class="w">    </span><span class="c"># which takes the plot generated in each loop</span>
<span class="w">    </span><span class="c"># and wraps it into an object that it knows how to </span>
<span class="w">    </span><span class="c"># make a video from</span>
<span class="w">    </span><span class="n">anim</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nd">@animate</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eachindex</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
<span class="w">        </span><span class="n">update!</span><span class="p">(</span><span class="n">progress_meter</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="w">        </span><span class="c"># Generate path</span>
<span class="w">        </span><span class="n">x_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="n">y_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="n">plt</span><span class="o">=</span><span class="n">visualize</span><span class="p">(</span><span class="n">billiard</span><span class="p">)</span>
<span class="w">        </span><span class="n">Plots</span><span class="o">.</span><span class="n">plot!</span><span class="p">(</span><span class="n">x_path</span><span class="p">,</span><span class="w"> </span><span class="n">y_path</span><span class="p">,</span><span class="w"> </span><span class="n">linecolor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">:black</span><span class="p">,</span>
<span class="w">            </span><span class="n">xlabel</span><span class="o">=</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>


<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="c"># Generate chem-trails</span>
<span class="w">            </span><span class="n">x_trail</span><span class="o">=</span><span class="n">reverse</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="n">traillength</span><span class="p">)</span><span class="o">:</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="n">y_trail</span><span class="o">=</span><span class="n">reverse</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="n">traillength</span><span class="p">)</span><span class="o">:</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="n">n</span><span class="o">=</span><span class="n">length</span><span class="p">(</span><span class="n">x_trail</span><span class="p">)</span>
<span class="w">            </span><span class="n">widths</span><span class="w"> </span><span class="o">=</span><span class="n">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">            </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>

<span class="w">            </span><span class="n">Plots</span><span class="o">.</span><span class="n">plot!</span><span class="p">(</span><span class="n">x_trail</span><span class="p">,</span><span class="n">y_trail</span><span class="p">,</span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="n">widths</span><span class="p">,</span>
<span class="w">                </span><span class="n">seriesalpha</span><span class="w"> </span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="nb">false</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span>
<span class="w">        </span><span class="n">Plots</span><span class="o">.</span><span class="n">scatter!</span><span class="p">(</span>
<span class="w">            </span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
<span class="w">            </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">:black</span><span class="p">,</span>
<span class="w">            </span><span class="n">markersize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">            </span><span class="n">markerstrokewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">markerstrokecolor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">:orange</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span>
<span class="w">        </span><span class="n">Plots</span><span class="o">.</span><span class="n">annotate!</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;time=&quot;</span><span class="o">*</span><span class="n">string</span><span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="n">digits</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">Plots</span><span class="o">.</span><span class="n">gif</span><span class="p">(</span><span class="n">anim</span><span class="p">,</span><span class="w"> </span><span class="n">fps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span>
<span class="k">end</span><span class="w"> </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">ts1</span><span class="o">=</span><span class="n">timeseries</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="mf">0.2</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c">#animatebilliard(ts1...)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">s2</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">rectangular_billiard</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="o">-</span><span class="mf">0.801</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">500</span><span class="p">);</span>
<span class="n">ts2</span><span class="o">=</span><span class="n">timeseries</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span>
<span class="c">#animatebilliard(ts2...)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="circular-billiard">
<h2>Circular Billiard<a class="headerlink" href="#circular-billiard" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">circular_billiard</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ball_x</span><span class="p">,</span><span class="n">ball_y</span><span class="p">,</span><span class="n">ball_vx</span><span class="p">,</span><span class="n">ball_vy</span><span class="p">,</span><span class="n">ball_t</span><span class="p">)</span>
<span class="w">    </span><span class="n">Billiard</span><span class="p">([</span><span class="n">Cwall</span><span class="p">(</span><span class="n">r</span><span class="p">)],</span>
<span class="w">        </span><span class="n">Ball</span><span class="p">(</span><span class="n">ball_x</span><span class="p">,</span><span class="n">ball_y</span><span class="p">,</span><span class="n">ball_vx</span><span class="p">,</span><span class="n">ball_vy</span><span class="p">,</span><span class="n">ball_t</span><span class="p">),</span>
<span class="w">        </span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>
<span class="k">end</span>

<span class="c"># If you don&#39;t give a location/speed for the ball, just put it at the origin</span>

<span class="n">circular_billiard</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">=</span><span class="n">circular_billiard</span><span class="p">(</span>
<span class="w">    </span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="n">circular_billiard</span><span class="p">(</span><span class="n">r</span><span class="p">,</span>
<span class="w">    </span><span class="n">ball_x</span><span class="p">,</span><span class="n">ball_y</span><span class="p">,</span><span class="n">ball_vx</span><span class="p">,</span><span class="n">ball_vy</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="n">circular_billiard</span><span class="p">(</span>
<span class="w">    </span><span class="n">r</span><span class="p">,</span><span class="n">ball_x</span><span class="p">,</span><span class="n">ball_y</span><span class="p">,</span><span class="n">ball_vx</span><span class="p">,</span><span class="n">ball_vy</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b3</span><span class="o">=</span><span class="n">circular_billiard</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">s3</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">b3</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">visualize</span><span class="p">(</span><span class="n">s3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We see that the trajectories seem to “accumulate” on a ring.  This is referred to as a “caustic”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">poincare</span><span class="p">(</span><span class="n">s3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="c">#eventanimate(s3)</span>
</pre></div>
</div>
</div>
</div>
<section id="sinai-billiards">
<h3>Sinai Billiards<a class="headerlink" href="#sinai-billiards" title="Permalink to this heading">#</a></h3>
<p>If we put a circular wall inside a rectangular Billiard, we get more interesting behavior</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b_sinai</span><span class="o">=</span><span class="w"> </span><span class="n">Billiard</span><span class="p">([</span><span class="n">Hwall</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Hwall</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span><span class="n">Cwall</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
<span class="w">    </span><span class="n">Ball</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">),[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">b_sinai</span><span class="p">,</span><span class="n">aspectratio</span><span class="o">=</span><span class="ss">:equal</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now if we watch the ball motion, it appears chaotic</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">ss</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">b_sinai</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
<span class="c">#eventanimate(ss)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">poincare</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Lets fill that in a bit more</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">longss</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">b_sinai</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span>
<span class="n">poincare</span><span class="p">(</span><span class="n">longss</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that other initial conditions are regular</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b_sinai2</span><span class="o">=</span><span class="w"> </span><span class="n">Billiard</span><span class="p">([</span><span class="n">Hwall</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Hwall</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span><span class="n">Cwall</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
<span class="w">    </span><span class="n">Ball</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ss2</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">b_sinai2</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">ss2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="sensitive-dependence-on-initial-condidtions">
<h3>Sensitive dependence on initial condidtions<a class="headerlink" href="#sensitive-dependence-on-initial-condidtions" title="Permalink to this heading">#</a></h3>
<p>As before, to explore chaos, we want to look at the Jacobian</p>
<div class="amsmath math notranslate nohighlight" id="equation-61353245-5a62-4090-96b0-e7aad338b9f6">
<span class="eqno">(96)<a class="headerlink" href="#equation-61353245-5a62-4090-96b0-e7aad338b9f6" title="Permalink to this equation">#</a></span>\[\begin{equation}
J=\left(\begin{array}{cccc}
\frac{\partial x}{\partial x_0}&amp;
\frac{\partial x}{\partial y_0}&amp;
\frac{\partial x}{\partial vx_0}&amp;
\frac{\partial x}{\partial vy_0}\\
\frac{\partial y}{\partial x_0}&amp;
\frac{\partial y}{\partial y_0}&amp;
\frac{\partial y}{\partial vx_0}&amp;
\frac{\partial y}{\partial vy_0}\\
\frac{\partial vx}{\partial x_0}&amp;
\frac{\partial vx}{\partial y_0}&amp;
\frac{\partial vx}{\partial vx_0}&amp;
\frac{\partial vx}{\partial vy_0}\\
\frac{\partial vy}{\partial x_0}&amp;
\frac{\partial vy}{\partial y_0}&amp;
\frac{\partial vy}{\partial vx_0}&amp;
\frac{\partial vy}{\partial vy_0}\\
\end{array}\right),
\end{equation}\]</div>
<p>evaluated at the bounces.</p>
<p>To find these derivatives we will use the <code class="docutils literal notranslate"><span class="pre">ForwardDiff</span></code> package</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">ForwardDiff</span><span class="w"> </span><span class="c"># load package</span>
<span class="n">FD</span><span class="o">=</span><span class="n">ForwardDiff</span><span class="w"> </span><span class="c"># rename package, for easy reference</span>
</pre></div>
</div>
</div>
</div>
<p>We then want to make some helper routines that makes the coordinates in <code class="docutils literal notranslate"><span class="pre">ball</span></code> these dual vectors</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">dualxv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="n">FD</span><span class="o">.</span><span class="n">Dual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">FD</span><span class="o">.</span><span class="n">Partials</span><span class="p">((</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">))),</span>
<span class="w">            </span><span class="n">FD</span><span class="o">.</span><span class="n">Dual</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">FD</span><span class="o">.</span><span class="n">Partials</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">))),</span>
<span class="w">            </span><span class="n">FD</span><span class="o">.</span><span class="n">Dual</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span><span class="n">FD</span><span class="o">.</span><span class="n">Partials</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">))),</span>
<span class="w">            </span><span class="n">FD</span><span class="o">.</span><span class="n">Dual</span><span class="p">(</span><span class="n">vy</span><span class="p">,</span><span class="n">FD</span><span class="o">.</span><span class="n">Partials</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">)))]</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">dualball</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Ball</span><span class="p">(</span><span class="n">dualxv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">)</span><span class="o">...</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">jac</span><span class="p">(</span><span class="n">dball</span><span class="p">)</span>
<span class="w">    </span><span class="n">hcat</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="n">dball</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">partials</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<span class="w">        </span><span class="n">collect</span><span class="p">(</span><span class="n">dball</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">partials</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<span class="w">        </span><span class="n">collect</span><span class="p">(</span><span class="n">dball</span><span class="o">.</span><span class="n">vx</span><span class="o">.</span><span class="n">partials</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<span class="w">        </span><span class="n">collect</span><span class="p">(</span><span class="n">dball</span><span class="o">.</span><span class="n">vy</span><span class="o">.</span><span class="n">partials</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>Here is a simple example</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">xv1</span><span class="o">=</span><span class="n">dualxv</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="mf">3.</span><span class="p">,</span><span class="mf">4.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x1</span><span class="o">=</span><span class="n">xv1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">y1</span><span class="o">=</span><span class="n">xv1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">test</span><span class="o">=</span><span class="n">x1</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">y1</span><span class="o">^</span><span class="mi">2</span>
<span class="nd">@show</span><span class="w"> </span><span class="n">test</span><span class="o">.</span><span class="n">value</span>
<span class="nd">@show</span><span class="w"> </span><span class="n">test</span><span class="o">.</span><span class="n">partials</span>
</pre></div>
</div>
</div>
</div>
<p>That tells us that <span class="math notranslate nohighlight">\(d(x^2+y^2)/dx\)</span> evaluated at <span class="math notranslate nohighlight">\(x,y=(1,2)\)</span> is <span class="math notranslate nohighlight">\(2\)</span>,  and <span class="math notranslate nohighlight">\(d(x^2+y^2)/dx\)</span>, evaluated at the same point is <span class="math notranslate nohighlight">\(4\)</span>.</p>
<p>Here is using the <code class="docutils literal notranslate"><span class="pre">dualball</span></code> construction – on a rectangular billiard</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">ball_test1</span><span class="o">=</span><span class="n">dualball</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">billiard_test1</span><span class="o">=</span><span class="n">Billiard</span><span class="p">([</span><span class="n">Hwall</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Hwall</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span>
<span class="w">        </span><span class="n">Vwall</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)],</span><span class="n">ball_test1</span><span class="p">,[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">s_test1</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">billiard_test1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">poslist</span><span class="o">=</span><span class="p">[(</span><span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">event</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">s_test1</span><span class="o">.</span><span class="n">events</span><span class="p">]</span>
<span class="n">plot</span><span class="p">(</span><span class="n">poslist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Lets see what the Jacobian looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">jaclist</span><span class="o">=</span><span class="p">[</span><span class="n">jac</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">s_test1</span><span class="o">.</span><span class="n">events</span><span class="p">]</span>
<span class="n">eiglist</span><span class="o">=</span><span class="p">[</span><span class="n">eigvals</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">jaclist</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>There is always one zero eigenvalue, corresponding to moving in the direction of the velocity vector.  After that we always find that the dynamics are always some sort of reflections – which always end up keeping the distance between nearbye trajectories constant.</p>
<p>Lets now see what it is for the Sinai billiard</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="o">=</span><span class="w"> </span><span class="n">Billiard</span><span class="p">([</span><span class="n">Hwall</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Hwall</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">Vwall</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">),</span><span class="n">Cwall</span><span class="p">(</span><span class="mi">1</span><span class="p">)],</span>
<span class="w">    </span><span class="n">Ball</span><span class="p">(</span><span class="n">dualxv</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span><span class="o">...</span><span class="p">,</span><span class="mf">0.</span><span class="p">),[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ds</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="mi">50</span><span class="p">);</span>
<span class="n">jaclist</span><span class="o">=</span><span class="p">[</span><span class="n">jac</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">ds</span><span class="o">.</span><span class="n">events</span><span class="p">]</span>
<span class="n">eiglist</span><span class="o">=</span><span class="p">[</span><span class="n">eigvals</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">jaclist</span><span class="p">]</span>
<span class="n">scatter</span><span class="p">([</span><span class="n">maximum</span><span class="p">(</span><span class="n">abs</span><span class="o">.</span><span class="p">(</span><span class="n">e</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">eiglist</span><span class="p">],</span><span class="n">yscale</span><span class="o">=</span><span class="ss">:log10</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">xlabel</span><span class="o">=</span><span class="s">&quot;bounce&quot;</span><span class="p">,</span><span class="n">ylabel</span><span class="o">=</span><span class="s">&quot;maximum eigenvalue of jacobian&quot;</span><span class="p">)</span><span class="w"> </span>
</pre></div>
</div>
</div>
</div>
<p>Apparently nearebye trajectories diverge exponentially – indicating chaos.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.10"
        },
        kernelOptions: {
            name: "julia-1.10",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.10'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="More%20Duffing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Exploring Chaos with our Duffing Simulator</p>
      </div>
    </a>
    <a class="right-next"
       href="blankLAB%20Interacting%20Hard%20Spheres.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">LAB – Interacting Hard Spheres</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#class-hierarchies-and-abstract-types">Class Hierarchies and abstract types</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#billiard-class">Billiard Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ball-class">Ball Class</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wall-class">Wall Class</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-roundoff">Dealing with Roundoff</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#circular-walls">Circular Walls</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deciding-which-wall-to-collide-off-of">Deciding which wall to collide off of</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-velocity-after-collision">Setting Velocity after collision</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-loop">Main loop</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poincare-sections">Poincare sections</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#animation">Animation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#circular-billiard">Circular Billiard</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sinai-billiards">Sinai Billiards</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sensitive-dependence-on-initial-condidtions">Sensitive dependence on initial condidtions</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Erich Mueller
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>